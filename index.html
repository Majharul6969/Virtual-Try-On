<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Try-On</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 p-8 flex flex-col items-center min-h-screen">

    <div class="flex flex-col items-center">
        <h1 class="text-5xl md:text-6xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-600 mb-6 text-center">
            Virtual Try-On
        </h1>
        <p class="text-xl text-gray-300 mb-10 text-center max-w-2xl font-light">
            প্রথমে নিজের একটা ছবি আপলোড করুন, তারপর দ্বিতীয় অপশনে আপনার পছন্দের পোশাকের ছবি দিন। এবার দেখে নিন, নতুন লুকে আপনাকে কেমন মানাচ্ছে!
        </p>
    </div>

    <div class="flex flex-col md:flex-row space-y-8 md:space-y-0 md:space-x-12 w-full max-w-5xl">
        <!-- User Image Upload -->
        <div class="flex-1 bg-gray-800 p-6 rounded-3xl shadow-2xl flex flex-col items-center border-2 border-gray-700 hover:border-blue-500 transition-all duration-300">
            <label class="text-xl font-semibold mb-4 text-center">
                আপনার ছবি আপলোড করুন
            </label>
            <input
                type="file"
                id="userImageInput"
                accept="image/*"
                class="w-full text-sm text-gray-400
                       file:mr-4 file:py-2 file:px-4
                       file:rounded-full file:border-0
                       file:text-sm file:font-semibold
                       file:bg-purple-500 file:text-white
                       hover:file:bg-purple-600 transition-colors duration-200"
            />
            <div id="userImagePreview" class="mt-6 w-full max-w-sm rounded-xl overflow-hidden shadow-lg border-4 border-gray-600 hidden">
                <img id="userImage" class="w-full h-auto object-cover" />
            </div>
        </div>

        <!-- Outfit Image Upload -->
        <div class="flex-1 bg-gray-800 p-6 rounded-3xl shadow-2xl flex flex-col items-center border-2 border-gray-700 hover:border-purple-500 transition-all duration-300">
            <label class="text-xl font-semibold mb-4 text-center">
                পোশাকের ছবি আপলোড করুন
            </label>
            <input
                type="file"
                id="outfitImageInput"
                accept="image/*"
                class="w-full text-sm text-gray-400
                       file:mr-4 file:py-2 file:px-4
                       file:rounded-full file:border-0
                       file:text-sm file:font-semibold
                       file:bg-blue-500 file:text-white
                       hover:file:bg-blue-600 transition-colors duration-200"
            />
            <div id="outfitImagePreview" class="mt-6 w-full max-w-sm rounded-xl overflow-hidden shadow-lg border-4 border-gray-600 hidden">
                <img id="outfitImage" class="w-full h-auto object-cover" />
            </div>
        </div>
    </div>

    <button
        id="tryOnButton"
        class="mt-12 px-10 py-4 text-xl font-bold rounded-full shadow-lg transition-all duration-300 transform
               bg-gradient-to-r from-blue-500 to-purple-600 hover:scale-105 active:scale-95"
    >
        Get Result
    </button>
    <div id="loadingIndicator" class="mt-8 hidden">
        <svg class="animate-spin h-8 w-8 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
    </div>
    <div id="errorDisplay" class="mt-8 text-red-400 text-center font-semibold"></div>

    <!-- Result Image Section -->
    <div id="resultImageSection" class="mt-16 w-full max-w-xl bg-gray-800 p-8 rounded-3xl shadow-2xl border-2 border-gray-700 hidden">
        <h2 class="text-2xl font-bold text-center mb-6 text-gray-200">নতুন লুকে আপনি</h2>
        <div class="w-full rounded-xl overflow-hidden shadow-lg border-4 border-gray-600">
            <img id="resultImage" class="w-full h-auto object-cover" />
        </div>
    </div>

    <footer class="mt-16 w-full max-w-5xl text-center text-sm text-gray-400 py-8 border-t border-gray-700">
        Built by Majharul Islam
    </footer>

    <script>
        const userImageInput = document.getElementById('userImageInput');
        const outfitImageInput = document.getElementById('outfitImageInput');
        const userImagePreview = document.getElementById('userImage');
        const outfitImagePreview = document.getElementById('outfitImage');
        const tryOnButton = document.getElementById('tryOnButton');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorDisplay = document.getElementById('errorDisplay');
        const resultImageSection = document.getElementById('resultImageSection');
        const resultImage = document.getElementById('resultImage');

        const userImagePreviewContainer = document.getElementById('userImagePreview');
        const outfitImagePreviewContainer = document.getElementById('outfitImagePreview');

        // Function to convert file to base64 string
        const fileToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = (error) => reject(error);
            });
        };

        // Function to handle file input changes
        const handleFileChange = (inputElement, imageElement, previewContainer) => {
            const file = inputElement.files[0];
            if (file) {
                previewContainer.classList.remove('hidden');
                imageElement.src = URL.createObjectURL(file);
                errorDisplay.textContent = '';
            } else {
                previewContainer.classList.add('hidden');
            }
        };

        userImageInput.addEventListener('change', () => handleFileChange(userImageInput, userImagePreview, userImagePreviewContainer));
        outfitImageInput.addEventListener('change', () => handleFileChange(outfitImageInput, outfitImagePreview, outfitImagePreviewContainer));

        // Main function to call the image generation API
        const handleTryOn = async () => {
            const userFile = userImageInput.files[0];
            const outfitFile = outfitImageInput.files[0];

            if (!userFile || !outfitFile) {
                errorDisplay.textContent = 'Please upload both a picture of yourself and an outfit.';
                return;
            }

            tryOnButton.disabled = true;
            tryOnButton.textContent = 'Trying On...';
            tryOnButton.classList.add('bg-gray-600', 'cursor-not-allowed');
            tryOnButton.classList.remove('bg-gradient-to-r', 'from-blue-500', 'to-purple-600', 'hover:scale-105', 'active:scale-95');
            loadingIndicator.classList.remove('hidden');
            resultImageSection.classList.add('hidden');
            errorDisplay.textContent = '';

            try {
                const userBase64 = await fileToBase64(userFile);
                const outfitBase64 = await fileToBase64(outfitFile);

                const userPrompt = "Generate an image of the person wearing the new outfit. Maintain the same pose, background, and lighting. Make it look as realistic as possible.";
                const payload = {
                    contents: [
                        {
                            parts: [
                                { text: userPrompt },
                                { inlineData: { mimeType: userFile.type, data: userBase64 } },
                                { text: "Outfit to wear:" },
                                { inlineData: { mimeType: outfitFile.type, data: outfitBase64 } },
                            ],
                        },
                    ],
                    generationConfig: {
                        responseModalities: ["TEXT", "IMAGE"],
                    },
                };

                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;

                let retries = 0;
                const maxRetries = 3;
                let response;

                while (retries < maxRetries) {
                    try {
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.status === 429) {
                            retries++;
                            const delay = Math.pow(2, retries) * 1000;
                            await new Promise(res => setTimeout(res, delay));
                            continue;
                        }

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        break;
                    } catch (e) {
                        if (retries === maxRetries - 1) throw e;
                        retries++;
                        const delay = Math.pow(2, retries) * 1000;
                        await new Promise(res => setTimeout(res, delay));
                    }
                }

                const result = await response.json();
                const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

                if (base64Data) {
                    resultImage.src = `data:image/png;base64,${base64Data}`;
                    resultImageSection.classList.remove('hidden');
                } else {
                    errorDisplay.textContent = 'Could not generate the image. The API may have returned an empty response. Please try again with different pictures.';
                }
            } catch (e) {
                console.error('API call failed:', e);
                errorDisplay.textContent = 'An error occurred. Please try again later.';
            } finally {
                loadingIndicator.classList.add('hidden');
                tryOnButton.disabled = false;
                tryOnButton.textContent = 'Get Result';
                tryOnButton.classList.remove('bg-gray-600', 'cursor-not-allowed');
                tryOnButton.classList.add('bg-gradient-to-r', 'from-blue-500', 'to-purple-600', 'hover:scale-105', 'active:scale-95');
            }
        };

        tryOnButton.addEventListener('click', handleTryOn);
    </script>
</body>
</html>
